<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administraci√≥n - Medi Logix</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .datetime-display {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .admin-table th{
            padding: 10px;
            text-align: center;
            font-size: 17px;
            background-color: #cfe6ff;
        }
        .admin-table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
            background-color: white;
        }
        .action-btn {
            margin: 0 5px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
        }
        .edit-btn {
            background-color: #b8d2f0;
            border: 1px solid #1a3e85;
        }
        .delete-btn {
            background-color: #f8c0c0;
            border: 1px solid #a94442;
        }
        .lista{
            background-color: white;
            display: flex;
            justify-content: center;
            font-size: 20px;
            height: 30px;
            margin: 0 auto;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="logo-area">
                <img src="{{ url_for('static', filename='medico.png') }}" alt="Logo" class="logo-icon">
                <span class="logo-text">MEDI LOGIX</span>
                <button class="add-pac-btn" onclick="openAddDoctorModal()">AGREGAR M√âDICO</button>
            </div>
            <div class="datetime-display" id="datetime"></div>
        </header>
        <h2 class="lista">Personal M√©dico Registrado</h2>
        <main class="main-panel">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Apellidos</th>
                        <th>Correo</th>
                        <th>Fecha Nacimiento</th>
                        <th>Especialidad</th>
                        <th>Username</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </main>
    </div>

    <!-- Modal A√±adir M√©dico -->
<div id="addDoctorModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeAddDoctorModal()">&times;</span>
        <div class="modal-header">
            <div class="circle-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" fill="black">
                    <path d="M0 0h24v24H0z" fill="none"/>
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
                </svg>
            </div>
            <h2>A√±adir M√©dico</h2>
        </div>
        <form class="modal-form">
            <label>C√©dula/Pasaporte</label>
            <input class="input1" type="text" placeholder="Ej: 1711576786" required>

            <label>Nombres Completos</label>
            <input class="input1" type="text" placeholder="Ej: Mar√≠a Gabriela Torres" required>

            <label>Especialidad</label>
            <input class="input1" type="text" placeholder="Ej: Cardiolog√≠a" required>

            <label>Tel√©fono</label>
            <input class="input1" type="text" placeholder="Ej: 0991234567" required>

            <label>Correo Electr√≥nico</label>
            <input class="input1" type="email" placeholder="Ej: ejemplo@correo.com" required>

            <div class="button-group">
                <button type="submit" class="save-btn">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar M√©dico -->
 <!-- Modal Editar M√©dico -->
<div id="editDoctorModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeEditDoctorModal()">&times;</span>
        <div class="modal-header">
            <div class="circle-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" fill="black">
                    <path d="M0 0h24v24H0z" fill="none"/>
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
                </svg>
            </div>
            <h2>Editar M√©dico</h2>
        </div>

        <!-- AQUI va el formulario nuevo -->
        <form id="editDoctorForm" class="modal-form">
            <input type="hidden" id="edit-id">

            <label>Nombres Completos</label>
            <input type="text" id="edit-nombres" required>

            <label>Especialidad</label>
            <input type="text" id="edit-especialidad" required>

            <label>Tel√©fono</label>
            <input type="text" id="edit-telefono" required>

            <label>Correo Electr√≥nico</label>
            <input type="email" id="edit-correo" required>

            <label>Fecha de Nacimiento</label>
            <input type="date" id="edit-fecha" required>

            <div class="button-group">
                <button type="submit" class="save-btn">Guardar</button>
            </div>
        </form>
    </div>
</div>


    <script>
        function updateDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString('es-EC', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const time = now.toLocaleTimeString('es-EC');
            document.getElementById('datetime').textContent = `${date} | ${time}`;
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        function openAddDoctorModal() {
            document.getElementById("addDoctorModal").style.display = "block";
        }

        function closeAddDoctorModal() {
            document.getElementById("addDoctorModal").style.display = "none";
        }

        window.addEventListener("click", function(event) {
            if (event.target === document.getElementById("addDoctorModal")) {
                closeAddDoctorModal();
            }
        });

        function openEditDoctorModal() {
            document.getElementById("editDoctorModal").style.display = "block";
        }

        function closeEditDoctorModal() {
            document.getElementById("editDoctorModal").style.display = "none";
        }

        window.addEventListener("click", function(event) {
            if (event.target === document.getElementById("editDoctorModal")) {
                closeEditDoctorModal();
            }
        });

document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Sesi√≥n expirada. Inicia sesi√≥n nuevamente.");
        return window.location.href = "/";
    }

    try {
        const res = await fetch("http://localhost:777/api/admin/medicos", {
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        const data = await res.json();

        if (!res.ok) {
            return alert(data.mensaje || "Error al obtener m√©dicos");
        }

        const tbody = document.querySelector(".admin-table tbody");
        tbody.innerHTML = ""; // limpia el tbody antes de llenar

        data.forEach(medico => {
const row = document.createElement("tr");
row.dataset.id = medico.id; 
row.innerHTML = `
  <td>${medico.nombre}</td>
  <td>${medico.apellido}</td>
  <td>${medico.correo}</td>
  <td>${medico.fecha_nac}</td>
  <td>${medico.especialidad}</td>
  <td>${medico.usuario}</td>
  <td>
      <button class="action-btn edit-btn">Editar</button>
      <button class="action-btn delete-btn">Eliminar</button>
  </td>
`;

            tbody.appendChild(row);
        });

    } catch (error) {
        console.error("Error al cargar m√©dicos:", error);
        alert("Error al conectar con el servidor.");
    }
});


document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("#addDoctorModal form");
    if (!form) return console.warn("‚ö†Ô∏è Formulario de m√©dico no encontrado");

    form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const inputs = this.querySelectorAll("input");
        const nombres = inputs[1].value.trim();
        const partes = nombres.trim().split(" ");
        const nombre = partes[0] || "Nombre";
        const apellido = partes.slice(1).join(" ") || "SinApellido";
        const usuario = (nombre + apellido).toLowerCase().replace(/\s+/g, "");
        const correo = inputs[4].value.trim();
        const especialidad = inputs[2].value.trim();
        const telefono = inputs[3].value.trim();
        const fecha_nac = "1990-01-01";
        const password = "medico123";

        const token = localStorage.getItem("token");
        if (!token) return alert("Sesi√≥n no v√°lida");

        const body = {
            usuario,
            password,
            nombre,
            apellido,
            correo,
            especialidad,
            fecha_nac,
            telefono
        };

        console.log("üîΩ Enviando m√©dico al backend:", body);

        try {
            const res = await fetch("http://localhost:777/api/admin/crear_medico", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });

            const data = await res.json();
            console.log("üì• Respuesta:", data);

            if (res.ok) {
                alert("M√©dico registrado correctamente");
                this.reset();
                closeAddDoctorModal();
                location.reload();
            } else {
                alert(data.mensaje || "Error al registrar m√©dico");
            }

        } catch (err) {
            console.error("Error al registrar m√©dico:", err);
            alert("No se pudo conectar al servidor");
        }
    });
});

document.addEventListener("click", function (e) {
    if (e.target.classList.contains("edit-btn")) {
        const row = e.target.closest("tr");
        const cells = row.querySelectorAll("td");

        // Aseg√∫rate de que el orden coincide con la tabla
        const nombre = cells[0].textContent.trim();
        const apellido = cells[1].textContent.trim();
        const correo = cells[2].textContent.trim();
        const fecha = cells[3].textContent.trim();
        const especialidad = cells[4].textContent.trim();
        const usuario = cells[5].textContent.trim();

        // Mostrar el modal
        openEditDoctorModal();

        // Rellenar el formulario
        document.getElementById("edit-nombres").value = nombre + " " + apellido;
        document.getElementById("edit-especialidad").value = especialidad;
        document.getElementById("edit-telefono").value = ""; 
        document.getElementById("edit-correo").value = correo;
        document.getElementById("edit-fecha").value = fecha;
        document.getElementById("edit-id").value = row.dataset.id || ""; 
    }
});

document.getElementById("editDoctorForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const token = localStorage.getItem("token");
    if (!token) return alert("Sesi√≥n expirada. Inicia sesi√≥n nuevamente.");

    const id = document.getElementById("edit-id").value;
    const nombres = document.getElementById("edit-nombres").value.trim();
    const partes = nombres.split(" ");
    const nombre = partes[0];
    const apellido = partes.slice(1).join(" ") || "Apellido";
    const correo = document.getElementById("edit-correo").value.trim();
    const telefono = document.getElementById("edit-telefono").value.trim();
    const especialidad = document.getElementById("edit-especialidad").value.trim();
    const fecha_nac = document.getElementById("edit-fecha").value;

    const body = {
        nombre,
        apellido,
        correo,
        telefono,
        especialidad,
        fecha_nac
    };

    console.log("üì§ Enviando actualizaci√≥n de m√©dico:", body);

    try {
        const res = await fetch(`http://localhost:777/api/admin/medico/${id}`, {
            method: "PUT",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        console.log("üì• Respuesta:", data);

        if (res.ok) {
            alert("M√©dico actualizado");
            closeEditDoctorModal();
            location.reload();
        } else {
            alert(data.mensaje || "‚ùå Error al actualizar m√©dico");
        }

    } catch (err) {
        console.error("‚ùå Error de red al actualizar m√©dico:", err);
        alert("No se pudo conectar al servidor");
    }
});
document.addEventListener("click", async function (e) {
    if (e.target.classList.contains("delete-btn")) {
        const row = e.target.closest("tr");
        const id = row.dataset.id;

        const confirmacion = confirm("¬øEst√°s seguro de eliminar este m√©dico?");
        if (!confirmacion) return;

        const token = localStorage.getItem("token");
        if (!token) return alert("Sesi√≥n expirada. Inicia sesi√≥n nuevamente.");

        try {
            const res = await fetch(`http://localhost:777/api/admin/medico/${id}`, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            const data = await res.json();
            console.log("Respuesta de eliminaci√≥n:", data);

            if (res.ok) {
                alert("M√©dico eliminado correctamente");
                location.reload(); // refresca la tabla
            } else {
                alert(data.mensaje || "Error al eliminar m√©dico");
            }

        } catch (err) {
            console.error("‚ùå Error al eliminar m√©dico:", err);
            alert("No se pudo conectar al servidor");
        }
    }
});


    </script>
</body>
</html>
